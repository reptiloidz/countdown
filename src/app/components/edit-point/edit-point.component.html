<div
	class="root__loading-marker"
	*ngIf="loading"
></div>
<app-date-panel
	*ngIf="this.dates?.length"
	[loading]="loading"
	[pointDate]="pointDate"
	[selectedIterationDate]="selectedIterationDate"
	[isEditing]="true"
	(iterationSwitched)="switchIteration($event)"
	(addIteration)="addIterationHandler()"
></app-date-panel>
<div class="content content--row">
	<div
		*ngIf="point; else pointPlaceholder"
		app-main-item
		class="color content__col"
		[ngClass]="'color--' + this.form.controls['color'].value"
		[point]="point"
		[isEdit]="true"
	></div>
	<form
		*ngIf="!(checking | async); else loader"
		class="content__col"
		[formGroup]="form"
		(ngSubmit)="submit(repeatableValueSaved && !isCreation)"
	>
		<h3>{{ pageTitle }}</h3>
		<div
			class="form"
			[ngClass]="{
				'form--single': !repeatableValueSaved || isCreation,
			}"
		>
			<!-- Надо ли показывать автора? Сейчас редактировать больше никто не может -->
			<!-- <img
				*ngIf="userData?.photoURL"
				class="userpic userpic--sm"
				[src]="userData.photoURL"
				[alt]="userData.displayName"
				aria-hidden="true"
				><ng-container *ngIf="userData?.displayName">
				{{ userData.displayName }}
				</ng-container> -->
			<div class="form__section">
				<div class="form__row">
					<app-input
						class="form__control"
						placeholder="Название"
						icon="flag"
						formControlName="title"
					></app-input>
				</div>
				<div class="form__row">
					<app-input
						class="form__control"
						[textarea]="true"
						[textareaRows]="3"
						placeholder="Описание события"
						formControlName="description"
					></app-input>
				</div>

				<div class="form__row">
					<app-switcher
						*ngIf="!isCreationUrl"
						[items]="directionList"
						[value]="this.point?.direction || 'forward'"
						formControlName="direction"
						[showTitle]="true"
					></app-switcher>
					<app-drop
						#colorDrop
						formControlName="color"
						class="form__color"
						[buttonTextClass]="['color', 'color--' + pointColor, 'drop__item-color']"
						[select]="true"
						[buttonLabel]="pointColorName"
					>
						<ng-template #bodyTemplate>
							<button
								*ngFor="let pointColorsItem of pointColors"
								app-button
								class="drop__item"
								[ngClass]="{
									'drop__item--selected': pointColorsItem === pointColor
								}"
								[textClass]="['drop__item-text']"
								(click)="switchColor(pointColorsItem)"
							>
								<span [class]="'drop__item-color color color--' + pointColorsItem">
									{{ pointColorNames[pointColorsItem] }}
								</span>
								<svg
									app-svg
									name="check"
									size="sm"
									class="drop__item-icon"
								></svg>
							</button>
						</ng-template>
					</app-drop>
					<div
						*ngIf="!isCreationUrl"
						class="form__checks"
					>
						<label
							app-checkbox
							mode="custom"
							icon="globe"
							formControlName="greenwich"
							[title]="greenwichValue ? 'Время по Гринвичу' : 'Локальное время'"
						></label>
						<label
							app-checkbox
							mode="custom"
							icon="users"
							formControlName="public"
							[title]="publicValue ? 'Публичное событие' : 'Приватное событие'"
						></label>
						<label
							app-checkbox
							mode="custom"
							icon="refresh"
							formControlName="repeatable"
							[title]="repeatableValue ? 'Повторяемое событие' : 'Однократное событие'"
						></label>
					</div>
					<app-switcher
						*ngIf="isCreationUrl"
						[items]="dateModeList"
						[value]="dateUrlMode"
						[showTitle]="true"
						(valueSwitched)="switchDateUrlMode($event)"
					></app-switcher>
				</div>
				<div class="form__row">
					<button
						*ngIf="repeatableValueSaved && !isCreation"
						app-button
						class="form__submit"
						mode="ghost"
						iconPosition="right"
						icon="arrow-right"
						type="button"
						(click)="submit()"
						title="Сохранить параметры события"
					>Сохранить</button>
				</div>
			</div>

			<h3
				*ngIf="repeatableValueSaved && !isCreation"
				class="form__section-title"
			>Редактирование итерации</h3>

			<div class="form__section">
				<div class="form__row">
					<app-datepicker
						horizontal="left"
						class="form__btn form__col"
						(datePicked)="datePicked($event)"
						[date]="pointDate"
					></app-datepicker>
					<app-drop
						[dropList]="differenceModeArray"
						(dropChanged)="differenceModeChanged($event)"
						[value]="differenceMode"
						class="form__col form__col--right"
					></app-drop>
					<app-input
						placeholder="Прошло/осталось"
						formControlName="difference"
						autocomplete="off"
						mask="0*"
						[allowNegativeNumbers]="true"
						[validation]="false"
						[maxlength]="validatorDifferenceMaxLength"
						[clearButton]="true"
						clearButtonTitle="Сброс (итерация произошла сейчас)"
						clearButtonValue="0"
						(reset)="differenceChanged(0)"
					></app-input>
				</div>
				<div class="form__row">
					<app-drop
						*ngIf="repeatableValueSaved && !isCreation"
						class="drop--nested form__col"
					>
						<ng-template
							#triggerTemplate
							let-toggle="toggle"
						>
							<button
								app-button
								class="form__btn"
								mode="secondary"
								icon="chevron-down"
								(click)="toggle()"
							>Генерация итераций</button>
						</ng-template>
						<ng-template #bodyTemplate>
							<app-generate-iterations
								class="generation"
								[loading]="loading"
								[form]="formGroup"
								(repeatsAreGenerated)="getRepeats($event)"
								[point]="point"
							></app-generate-iterations>
						</ng-template>
					</app-drop>
					<button
						app-button
						class="form__submit"
						type="submit"
						mode="ghost"
						icon="arrow-right"
						iconPosition="right"
						[attr.disabled]="(loading || (repeatableValueSaved && !isCreation ? !isDateFormValid : !isBaseFormValid || !isDateFormValid)) || null"
						[title]="repeatableValueSaved && !isCreation ? 'Сохранить параметры итерации' :
											'Сохранить событие'"
					>Сохранить</button>
				</div>
			</div>

		</div>
	</form>
</div>

<ng-template #loader>
	<div class="root__loading-marker"></div>
</ng-template>

<ng-template #pointPlaceholder>
	<app-clock
		class="content__col content__clock content__clock--form"
		innerClass="content__clock-inner"
	></app-clock>
</ng-template>
