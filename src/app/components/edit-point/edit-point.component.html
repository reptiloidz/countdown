<form
	class="main__inner color"
	[ngClass]="'color--' + this.form.controls['color'].value"
	*ngIf="!(checking | async); else loader"
	[formGroup]="form"
	(ngSubmit)="submit(isRepeatable && !isCreation)"
>
	<app-date-panel
		*ngIf="this.dates?.length"
		[loading]="loading"
		[pointDate]="pointDate"
		[selectedIterationDate]="selectedIterationDate"
		[isEditing]="true"
		(iterationSwitched)="switchIteration($event, true)"
		(addIteration)="addIterationHandler()"
	></app-date-panel>
	<h1>{{ pageTitle }}<span
			*ngIf="loading"
			class="loader rotating"
		></span></h1>
	<div class="form">
		<!-- Надо ли показывать автора? Сейчас редактировать больше никто не может -->
		<!-- <img
			*ngIf="userData?.photoURL"
			class="userpic userpic--sm"
			[src]="userData.photoURL"
			[alt]="userData.displayName"
			aria-hidden="true"
			><ng-container *ngIf="userData?.displayName">
			{{ userData.displayName }}
			</ng-container> -->
		<div class="form__row">
			<div class="form__body">
				<app-input
					placeholder="Название"
					type="text"
					formControlName="title"
				></app-input>
				<app-input
					[textarea]="true"
					placeholder="Описание события"
					formControlName="description"
				></app-input>
			</div>
			<div
				*ngIf="!isCreationUrl"
				class="form__aside"
			>
				<app-switcher
					[items]="directionList"
					[value]="this.point?.direction || 'forward'"
					formControlName="direction"
				></app-switcher>
				<label
					app-checkbox
					mode="custom"
					icon="globe"
					formControlName="greenwich"
					title="Время по Гринвичу (убрать, если время должно быть местным)"
				></label>
				<label
					app-checkbox
					mode="custom"
					icon="users"
					formControlName="public"
					title="Публичное событие"
				></label>
				<label
					app-checkbox
					mode="custom"
					icon="refresh"
					formControlName="repeatable"
					title="Повторяемое событие"
				></label>
				<app-drop
					vertical="top"
					formControlName="color"
					[dropList]="pointColorNames"
				></app-drop>
			</div>
		</div>

		<p
			class="info"
			*ngIf="isCreation && isRepeatable"
		>
			Изменение итераций будет доступно после создания события
		</p>
		<p
			class="info"
			*ngIf="!isCreation && !isRepeatable && hasManyIterations"
		>
			Отключены повторы события. Все итерации кроме последней будут удалены
		</p>

		<div class="form__row">
			<div class="form__col">
				<ng-container *ngIf="isRepeatable && !isCreation">
					<app-drop vertical="top">
						<ng-template
							#buttonTemplate
							let-toggle="toggle"
						>
							<button
								app-button
								mode="ghost"
								icon="chevron-down"
								(click)="toggle()"
							>Генерация итераций</button>
						</ng-template>
						<ng-template #bodyTemplate>
							<app-generate-iterations
								[loading]="loading"
								[form]="formGroup"
								(repeatsIsGenerated)="getRepeats($event)"
							></app-generate-iterations>
						</ng-template>
					</app-drop>
					<button
						app-button
						[disabled]="loading || !isBaseFormValid"
						mode="primary"
						type="button"
						(click)="submit()"
					>Сохранить событие</button>
				</ng-container>
			</div>
			<div class="form__col">
				<app-datepicker
					vertical="top"
					(datePicked)="datePicked($event)"
					[date]="pointDate"
				></app-datepicker>

				<app-input
					type="text"
					placeholder="Срок в минутах"
					formControlName="difference"
					mask="0*"
					[allowNegativeNumbers]="true"
					[validation]="false"
					[maxlength]="validatorDifferenceMaxLength"
					[clearButton]="true"
					clearButtonTitle="Сброс (итерация произошла сейчас)"
					clearButtonValue="0"
				></app-input>
				<button
					app-button
					type="submit"
					mode="positive"
					[disabled]="loading || (isRepeatable && !isCreation ? !isDateFormValid : !isBaseFormValid || !isDateFormValid)"
					[title]="isRepeatable && !isCreation ? 'Сохранить параметры итерации' :
					'Сохранить событие'"
				>
					{{ 'Сохранить' }}
				</button>
			</div>
		</div>
	</div>
</form>

<ng-template #loader>
	<h2>
		<div class="loader rotating"></div>
	</h2>
</ng-template>
