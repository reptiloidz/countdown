<form
	class="main__inner color"
	[ngClass]="'color--' + this.form.controls['color'].value"
	*ngIf="!(checking | async); else loader"
	[formGroup]="form"
	(ngSubmit)="submit(isRepeatable && !isCreation)"
>
	<app-calendar
		*ngIf="this.dates?.length"
		(dateSelected)="dateSelected($event)"
		(modeSelected)="modeSelected($event)"
		[iterations]="point?.dates"
		class="calendar"
		[selectedDate]="selectedIterationDate"
		[visibleDate]="selectedIterationDate"
		[point]="point"
	>
		<ng-template
			#navTemplate
			let-date="date"
			let-mode="mode"
			let-point="point"
		>
			<ng-container *ngIf="date.iterations.length && point.repeatable">
				<button
					app-button
					mode="positive"
					size="sm"
					icon="document-check"
					class="calendar__btn-nav"
					title="Отметить все итерации даты"
					(click)="dateChecked({
						check: true,
						data: date.iterations
					})"
				></button>
				<button
					app-button
					mode="secondary"
					size="sm"
					icon="document-cross"
					class="calendar__btn-nav"
					title="Снять отметки со всех итераций даты"
					(click)="dateChecked({
						check: false,
						data: date.iterations
					})"
				></button>
			</ng-container>
		</ng-template>
	</app-calendar>
	<h1>{{ pageTitle }}<span
			*ngIf="loading"
			class="loader rotating"
		></span></h1>
	<div class="form">
		<!-- Надо ли показывать автора? Сейчас редактировать больше никто не может -->
		<!-- <img
			*ngIf="userData?.photoURL"
			class="userpic userpic--sm"
			[src]="userData.photoURL"
			[alt]="userData.displayName"
			aria-hidden="true"
			><ng-container *ngIf="userData?.displayName">
			{{ userData.displayName }}
			</ng-container> -->
		<div class="form__row">
			<div class="form__body">
				<app-input
					placeholder="Название"
					type="text"
					formControlName="title"
				></app-input>
				<app-input
					[textarea]="true"
					placeholder="Описание события"
					formControlName="description"
				></app-input>
			</div>
			<div
				*ngIf="!isCreationUrl"
				class="form__aside"
			>
				<app-switcher
					[items]="directionList"
					[value]="this.point?.direction || 'forward'"
					formControlName="direction"
				></app-switcher>
				<label
					app-checkbox
					mode="custom"
					icon="globe"
					formControlName="greenwich"
					title="Время по Гринвичу (убрать, если время должно быть местным)"
				></label>
				<label
					app-checkbox
					mode="custom"
					icon="users"
					formControlName="public"
					title="Публичное событие"
				></label>
				<label
					app-checkbox
					mode="custom"
					icon="refresh"
					formControlName="repeatable"
					title="Повторяемое событие"
				></label>
				<app-drop
					vertical="top"
					formControlName="color"
					[dropList]="pointColorNames"
				></app-drop>
			</div>
		</div>

		<p
			class="info"
			*ngIf="isCreation && isRepeatable"
		>
			Изменение итераций будет доступно после создания события
		</p>
		<p
			class="info"
			*ngIf="!isCreation && !isRepeatable && hasManyIterations"
		>
			Отключены повторы события. Все итерации кроме последней будут удалены
		</p>

		<div class="form__row">
			<div
				*ngIf="isRepeatable && !isCreation"
				class="form__col"
			>
				<app-drop vertical="top">
					<ng-template
						#buttonTemplate
						let-toggle="toggle"
					>
						<button
							app-button
							mode="ghost"
							icon="chevron-down"
							(click)="toggle()"
						>Генерация итераций</button>
					</ng-template>
					<ng-template #bodyTemplate>
						<app-generate-iterations
							[loading]="loading"
							[form]="formGroup"
							(repeatsIsGenerated)="getRepeats($event)"
						></app-generate-iterations>
					</ng-template>
				</app-drop>
				<button
					app-button
					[disabled]="loading || !isBaseFormValid"
					mode="primary"
					type="button"
					(click)="submit()"
				>Сохранить событие</button>
			</div>
			<div class="form__col">
				<app-datepicker
					vertical="top"
					(datePicked)="datePicked($event)"
					[date]="pointDate"
				></app-datepicker>

				<app-input
					type="text"
					placeholder="Срок в минутах"
					formControlName="difference"
					mask="0*"
					[allowNegativeNumbers]="true"
					[validation]="false"
					[maxlength]="validatorDifferenceMaxLength"
					[clearButton]="true"
					clearButtonTitle="Сброс (итерация произошла сейчас)"
					clearButtonValue="0"
				></app-input>
				<button
					app-button
					type="submit"
					mode="positive"
					[disabled]="loading || (isRepeatable && !isCreation ? !isDateFormValid : !isBaseFormValid || !isDateFormValid)"
					[title]="isRepeatable && !isCreation ? 'Сохранить параметры итерации' :
					'Сохранить событие'"
				>
					{{ 'Сохранить' }}
				</button>
			</div>
		</div>
	</div>

	<ul
		#iterationsList
		*ngIf="isRepeatable && !isCreation"
		class="tabs"
	>
		<li
			*ngFor="let date of dates; let i = index"
			class="tabs__item"
			[ngClass]="{
				'tabs__item--active': i == currentIterationIndex && !isIterationAdded,
				'tabs__item--day': (i >= firstIterationIndex) && (i < selectedIterationsNumber + firstIterationIndex) && !isIterationAdded,
				'tabs__item--copy': i | checkCopies : point,
			}"
		>
			<button
				class="link tabs__btn"
				(click)="switchIteration(i, true)"
				type="button"
			>{{ i + 1 }}
				<ng-container *ngIf="date.reason === 'frequency'">*</ng-container>
			</button>

			<ng-container *ngIf="dates?.length && (dates?.length != 1)">
				<button
					class="link"
					(click)="removeIteration(i)"
					type="button"
				>x</button>
				<input
					type="checkbox"
					[name]="i"
					(change)="checkIteration()"
				>
			</ng-container>
		</li>
		<li
			class="tabs__item"
			[ngClass]="{
					'tabs__item--active': isIterationAdded
				}"
		>
			<button
				class="link tabs__btn"
				(click)="addIteration()"
				type="button"
			>+</button>
		</li>
	</ul>
	<div *ngIf="!loading && isDatesLengthPlural">
		<button
			app-button
			size="sm"
			mode="positive"
			icon="document-check"
			title="Выбрать все итерации"
			(click)="checkAllIterations()"
		></button>
		<ng-container *ngIf="iterationsChecked.length">
			<button
				app-button
				size="sm"
				mode="secondary"
				[attr.disabled]="iterationsChecked.length ? null : true"
				icon="document-cross"
				title="Снять выбор со всех итераций"
				(click)="checkAllIterations(false)"
			></button>
			<button
				app-button
				size="sm"
				mode="negative"
				icon="cross"
				title="Удалить выбранные итерации"
				(click)="removeCheckedIterations()"
			></button>
		</ng-container>
	</div>

</form>

<ng-template #loader>
	<h2>
		<div class="loader rotating"></div>
	</h2>
</ng-template>
