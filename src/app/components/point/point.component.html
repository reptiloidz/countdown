<app-panel
	icon="calendar"
	buttonSize="lg"
	[open]="calendarOpen"
	(panelVisibilitySwitched)="switchCalendarPanel($event)"
>
	<ng-template #bodyTemplate>
		<app-calendar
			*ngIf="this.dates?.length"
			(dateSelected)="dateSelected($event)"
			(modeSelected)="modeSelected($event)"
			[iterations]="point?.dates"
			class="calendar"
			[selectedDate]="selectedIterationDate"
			[visibleDate]="selectedIterationDate"
			[point]="point"
			(created)="calendarCreated()"
		>
			<ng-template
				#navTemplate
				let-date="date"
				let-mode="mode"
				let-point="point"
			>
				<ng-container *ngIf="date.iterations.length && point.repeatable">
					<button
						app-button
						mode="positive"
						size="sm"
						icon="document-check"
						class="calendar__btn-nav"
						title="Отметить все итерации даты"
						(click)="dateChecked({
							check: true,
							data: date.iterations
						})"
					></button>
					<button
						app-button
						mode="secondary"
						size="sm"
						icon="document-cross"
						class="calendar__btn-nav"
						title="Снять отметки со всех итераций даты"
						(click)="dateChecked({
							check: false,
							data: date.iterations
						})"
					></button>
				</ng-container>
			</ng-template>
		</app-calendar>
	</ng-template>

	<ng-container *ngIf="this.dates?.length && (this.dates?.length != 1)">
		<ng-template #extraTemplate>
			<ul
				#iterationsList
				class="tabs"
			>
				<li
					*ngFor="let date of this.dates; let i = index"
					class="tabs__item"
					[ngClass]="{
								'tabs__item--active': i == currentIterationIndex,
								'tabs__item--day': (i >= firstIterationIndex) && (i < selectedIterationsNumber + firstIterationIndex),
								'tabs__item--copy': i | checkCopies : point,
							}"
				>
					<button
						class="link tabs__btn"
						(click)="switchIteration(i)"
						type="button"
					>{{ i + 1 }}
						<ng-container *ngIf="date.reason === 'frequency'">*</ng-container>
					</button>
					<input
						*ngIf="hasAccess"
						type="checkbox"
						[name]="i"
						(change)="checkIteration()"
					>
					<button
						*ngIf="hasAccess"
						class="link"
						(click)="removeIteration(i)"
						type="button"
					>x</button>
				</li>
			</ul>

			<div *ngIf="hasAccess && !loading && !dateLoading && isDatesLengthPlural">
				<button
					type="button"
					(click)="checkAllIterations()"
				>Выбрать все</button>
				<ng-container *ngIf="iterationsChecked.length">
					<button
						type="button"
						(click)="checkAllIterations(false)"
					>Снять выбор</button>
					<button
						type="button"
						(click)="removeCheckedIterations()"
					>Удалить выбранные итерации</button>
				</ng-container>
			</div>
		</ng-template>
	</ng-container>
</app-panel>

<div class="content">
	<div class="point-page">
		<!-- <app-clock class="point-page__clock"></app-clock> -->
		<h1
			class="point-page__title color"
			[ngClass]="point?.color ? 'color--' + point?.color : ''"
		>{{ point?.title }}<span
				*ngIf="loading"
				class="loader rotating"
			></span></h1>

		<div
			*ngIf="!dateLoading; else dateLoader"
			class="timers"
		>
			<ng-container *ngIf="timerYears">
				<app-board
					[value]="timerYears"
					label="Годы"
					class="timers__item"
				></app-board>
				<span class="timers__divider">/</span>
			</ng-container>
			<ng-container *ngIf="timerMonths">
				<app-board
					[value]="timerMonths"
					label="Месяцы"
					class="timers__item"
				></app-board>
				<span class="timers__divider">/</span>
			</ng-container>
			<app-board
				*ngIf="timerDays"
				[value]="timerDays"
				label="Дни"
				class="timers__item timers__item--divided"
			></app-board>
			<app-board
				[value]="timerHours"
				label="Часы"
				class="timers__item timers__item--divided"
			></app-board>
			<span class="timers__divider">:</span>
			<app-board
				[value]="timerMins"
				label="Минуты"
				class="timers__item"
			></app-board>
			<span class="timers__divider">:</span>
			<app-board
				[value]="timerSecs"
				label="Секунды"
				class="timers__item"
			></app-board>
		</div>

		<div class="point-page__info">
			<div class="point-page__markers">
				<div
					class="marker"
					[ngClass]="{
						'marker--inactive': !point?.greenwich
					}"
					[title]="point?.greenwich ? 'По Гринвичу' : 'По местному времени'"
				>
					<svg
						app-svg
						name="globe"
						aria-hidden="false"
						class="marker__inner"
					></svg>
				</div>
				<div
					class="marker"
					[ngClass]="{
						'marker--inactive': !point?.repeatable
					}"
					[title]="point?.repeatable ? 'Повторяемое' : 'Однократное'"
				>
					<svg
						app-svg
						name="refresh"
						aria-hidden="false"
						class="marker__inner"
					></svg>
				</div>
				<div
					class="marker"
					[ngClass]="{
						'marker--inactive': !point?.public
					}"
					[title]="point?.public ? 'Публичное' : 'Приватное'"
				>
					<svg
						app-svg
						name="users"
						aria-hidden="false"
						class="marker__inner"
					></svg>
				</div>
			</div>
			<div class="point-page__author">
				<img
					*ngIf="userData?.photoURL"
					class="userpic userpic--sm"
					[src]="userData.photoURL"
					[alt]="userData.displayName"
					aria-hidden="true"
				><ng-container *ngIf="userData?.displayName">
					{{ userData.displayName }}
				</ng-container>
			</div>
		</div>

		<h2
			*ngIf="point?.title"
			class="description"
		>{{ remainTextValue }}</h2>
		<!-- <p
			*ngIf="!dateLoading; else dateLoader"
			class="timer"
			[attr.title]="iterationDate || null"
			>{{ dateTimer }} {{ timer }}</p> -->


		<ng-template #dateLoader>
			<h2>
				<div class="loader rotating"></div>
			</h2>
		</ng-template>
		<p *ngIf="point?.description">{{ point?.description }}</p>
	</div>
</div>
